@model SantaRamona.Backoffice.Models.Usuario
@{
    ViewData["Title"] = "Modificar usuario";
    var estados = ViewBag.Estados as Dictionary<int, string> ?? new();
}

<div class="container mt-4" style="font-family: Helvetica, Arial, sans-serif;">
    <h1 class="text-center fw-bold" style="color:#40ADB0; letter-spacing:.5px;">
        MODIFICAR USUARIO
    </h1>

    @if (ViewBag.Ok != null)
    {
        <div class="alert mt-3" style="background:#E6F6F5; border:1px solid #40ADB0; color:#155e59; border-radius:10px;">
            @ViewBag.Ok
        </div>
    }
    @if (ViewBag.ApiError != null)
    {
        <div class="alert mt-3" style="background:#FFE3E3; border:1px solid #A71A6C; color:#A71A6C; border-radius:10px;">
            @ViewBag.ApiError
        </div>
    }

    <div class="card shadow-sm mt-3" style="border:1px solid #40ADB0; border-radius:14px;">
        <div class="card-header d-flex justify-content-between align-items-center"
             style="background:#40ADB0; color:#fff; border-top-left-radius:14px; border-top-right-radius:14px;">
            <a asp-action="Index" class="btn"
               style="border:1px solid #fff; color:#fff; border-radius:10px;">← Volver al listado</a>

            <div class="d-flex gap-2">
                <button type="submit" form="form-modificar" class="btn"
                        style="background:#fff; color:#40ADB0; border-radius:10px; padding:.5rem 1.25rem;">
                    Guardar
                </button>
                <a asp-action="Index" class="btn"
                   style="background:#fff; color:#40ADB0; border-radius:10px; padding:.5rem 1.25rem;">
                    Cancelar
                </a>
            </div>
        </div>

        <div class="card-body">
            <form id="form-modificar" asp-controller="Usuario" asp-action="Modificar" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="id_usuario" />

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="nombre" class="form-label">Nombre</label>
                        <input asp-for="nombre" class="form-control" />
                        <span asp-validation-for="nombre" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="apellido" class="form-label">Apellido</label>
                        <input asp-for="apellido" class="form-control" />
                        <span asp-validation-for="apellido" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="email" class="form-label">Email</label>
                        <input asp-for="email" type="email" class="form-control" />
                        <span asp-validation-for="email" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="clave" class="form-label">Clave</label>
                        <input asp-for="clave" type="text" class="form-control" />
                        <span asp-validation-for="clave" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="direccion" class="form-label">Dirección</label>
                        <input asp-for="direccion" class="form-control" />
                    </div>

                    <div class="col-md-3">
                        <label asp-for="altura" class="form-label">Altura</label>
                        <input asp-for="altura" type="number" class="form-control" />
                        <span asp-validation-for="altura" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="departamento" class="form-label">Departamento</label>
                        <input asp-for="departamento" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label asp-for="telefono1" class="form-label">Teléfono 1</label>
                        <input asp-for="telefono1" type="number" class="form-control" />
                        <span asp-validation-for="telefono1" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="telefono2" class="form-label">Teléfono 2</label>
                        <input asp-for="telefono2" type="number" class="form-control" />
                        <span asp-validation-for="telefono2" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="fechaAlta" class="form-label">Fecha de Alta</label>
                        <input asp-for="fechaAlta" type="date" class="form-control" />
                        <span asp-validation-for="fechaAlta" style="color:#A71A6C;"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Estado</label>
                        <select asp-for="id_estadoUsuario" class="form-select" id="estadoSelect">
                            <option value="">-- Seleccione un estado --</option>
                            @foreach (var e in estados)
                            {
                                <option value="@e.Key" selected="@(Model.id_estadoUsuario == e.Key)">
                                    @e.Value
                                </option>
                            }
                            <option value="nuevo">+ Agregar nuevo estado...</option>
                        </select>
                        <span asp-validation-for="id_estadoUsuario" style="color:#A71A6C;"></span>
                    </div>
                </div>

                <div asp-validation-summary="ModelOnly" style="color:#A71A6C;" class="mt-2"></div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para agregar estado -->
<div class="modal fade" id="modalNuevoEstado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:14px;">
            <div class="modal-header" style="background:#40ADB0; color:#fff; border-top-left-radius:14px; border-top-right-radius:14px;">
                <h5 class="modal-title">Agregar nuevo estado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="nuevoEstadoDescripcion" class="form-label">Descripción del estado</label>
                <input type="text" id="nuevoEstadoDescripcion" class="form-control" placeholder="Ej: Suspendido" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn"
                        style="border:1px solid #40ADB0; color:#40ADB0; border-radius:10px;"
                        data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn"
                        style="background:#40ADB0; color:#fff; border-radius:10px;"
                        id="btnGuardarEstado">
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const estadoSelect = document.getElementById('estadoSelect');
        const modalNuevoEstado = new bootstrap.Modal(document.getElementById('modalNuevoEstado'));

        estadoSelect.addEventListener('change', function () {
            if (this.value === 'nuevo') {
                modalNuevoEstado.show();
                this.value = '';
            }
        });

        document.getElementById('btnGuardarEstado').addEventListener('click', async () => {
            const descripcion = document.getElementById('nuevoEstadoDescripcion').value.trim();
            if (!descripcion) return;

            const resp = await fetch('/Usuario/AgregarEstado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ descripcion })
            });

            if (resp.ok) {
                const nuevo = await resp.json();
                const option = new Option(nuevo.descripcion, nuevo.id);
                option.selected = true;
                estadoSelect.add(option, estadoSelect.options[estadoSelect.options.length - 1]);
                modalNuevoEstado.hide();
                document.getElementById('nuevoEstadoDescripcion').value = '';
            } else {
                alert('Error al agregar el estado.');
            }
        });
    </script>
}

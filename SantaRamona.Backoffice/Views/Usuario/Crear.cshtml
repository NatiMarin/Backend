@model SantaRamona.Backoffice.Models.Usuario
@{
    ViewData["Title"] = "Agregar Nuevo Usuario";
    var estados = ViewBag.Estados as Dictionary<int, string> ?? new();
}
@await Html.PartialAsync("_UsuarioTopNav")

<div class="container mt-4">
    <h1 class="text-center fw-bold" style="color:#40ADB0; letter-spacing:.5px;">
        AGREGAR NUEVO USUARIO
    </h1>

    @if (ViewBag.Ok != null)
    {
        <div class="alert mt-3" style="background:#E6F6F5;border:1px solid #40ADB0;color:#155e59;border-radius:10px;">
            @ViewBag.Ok
        </div>
    }
    @if (ViewBag.ApiError != null)
    {
        <div class="alert mt-3" style="background:#FFE3E3;border:1px solid #A71A6C;color:#A71A6C;border-radius:10px;">
            @ViewBag.ApiError
        </div>
    }

    <div class="card shadow-sm mt-3" style="border:1px solid #40ADB0;border-radius:14px;">
        <div class="card-header d-flex justify-content-between align-items-center"
             style="background:#40ADB0;color:#fff;border-top-left-radius:14px;border-top-right-radius:14px;">
            <a asp-action="Index" class="btn"
               style="border:1px solid #fff;color:#fff;border-radius:10px;">← Volver al listado</a>
            <div class="d-flex gap-2">
                <button type="submit" form="form-crear" class="btn"
                        style="background:#fff;color:#40ADB0;border-radius:10px;padding:.5rem 1.25rem;">
                    Guardar
                </button>
                <a asp-action="Index" class="btn"
                   style="background:#fff;color:#40ADB0;border-radius:10px;padding:.5rem 1.25rem;">
                    Cancelar
                </a>
            </div>
        </div>

        <div class="card-body">
            <form id="form-crear" asp-controller="Usuario" asp-action="Crear" method="post">
                @Html.AntiForgeryToken()

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="nombre" class="form-label">Nombre</label>
                        <input asp-for="nombre" class="form-control" />
                        <span asp-validation-for="nombre" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="apellido" class="form-label">Apellido</label>
                        <input asp-for="apellido" class="form-control" />
                        <span asp-validation-for="apellido" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="email" class="form-label">Email</label>
                        <input asp-for="email" class="form-control" type="email" />
                        <span asp-validation-for="email" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="clave" class="form-label">Contraseña</label>
                        <input asp-for="clave" class="form-control" type="password" />
                        <span asp-validation-for="clave" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="direccion" class="form-label">Dirección</label>
                        <input asp-for="direccion" class="form-control" />
                        <span asp-validation-for="direccion" class="text-danger"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="altura" class="form-label">Altura</label>
                        <input asp-for="altura" class="form-control" type="number" />
                        <span asp-validation-for="altura" class="text-danger"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="departamento" class="form-label">Departamento</label>
                        <input asp-for="departamento" class="form-control" />
                        <span asp-validation-for="departamento" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="telefono1" class="form-label">Teléfono 1</label>
                        <input asp-for="telefono1" class="form-control" type="tel" />
                        <span asp-validation-for="telefono1" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="telefono2" class="form-label">Teléfono 2</label>
                        <input asp-for="telefono2" class="form-control" type="tel" />
                        <span asp-validation-for="telefono2" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="fechaAlta" class="form-label">Fecha de Alta</label>
                        <input asp-for="fechaAlta" class="form-control" type="date" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="fechaAlta" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="id_estadoUsuario" class="form-label">Estado</label>
                        <select asp-for="id_estadoUsuario" class="form-select" id="select-estado">
                            <option value="">-- Seleccione un estado --</option>
                            @foreach (var e in estados)
                            {
                                <option value="@e.Key">@e.Value</option>
                            }
                            <!-- <option value="__nuevo__">➕ Agregar nuevo estado...</option> -->
                        </select>
                        <span asp-validation-for="id_estadoUsuario" class="text-danger"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para agregar nuevo estado -->
<div id="modal-estado" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999;">
    <div style="background:#fff; width:380px; margin:10% auto; padding:2rem; border-radius:1rem; text-align:center;">
        <h5 style="margin-bottom:1rem; color:#40ADB0;">Agregar nuevo estado</h5>
        <input id="nuevo-estado" type="text" placeholder="Ingrese descripción"
               style="width:100%; padding:.6rem; border:1px solid #ccc; border-radius:.4rem;" />
        <span id="estado-error" style="display:none; color:#A71A6C; font-size:.9rem; margin-top:.3rem;">Campo obligatorio</span>
        <div style="margin-top:1.2rem; display:flex; justify-content:center; gap:.5rem;">
            <button type="button" class="btn" style="background:#40ADB0;color:white;" onclick="guardarNuevoEstado()">Guardar</button>
            <button type="button" class="btn" style="background:#ccc;color:black;" onclick="cerrarModalEstado()">Cancelar</button>
        </div>
    </div>
</div>

Scripts {
    <script>
        <partial name="_ValidationScriptsPartial" />
        const selectEstado = document.getElementById("select-estado");
        const urlAgregarEstado = '@Url.Action("AgregarEstado", "Usuario")';

        selectEstado.addEventListener("change", function () {
            if (this.value === "__nuevo__") {
                document.getElementById("modal-estado").style.display = "block";
                this.value = "";
            }
        });

        async function guardarNuevoEstado() {
            const descripcion = document.getElementById("nuevo-estado").value.trim();
            const error = document.getElementById("estado-error");
            if (!descripcion) {
                error.style.display = "block";
                return;
            }
            error.style.display = "none";

            try {
                const resp = await fetch(urlAgregarEstado, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ descripcion })
                });
                if (!resp.ok) throw new Error("Error al crear el estado");

                const data = await resp.json();
                const option = new Option(data.descripcion, data.id);
                selectEstado.add(option);
                selectEstado.value = data.id;

                cerrarModalEstado();
            } catch (err) {
                alert("No se pudo guardar el estado: " + err.message);
            }
        }

        function cerrarModalEstado() {
            document.getElementById("modal-estado").style.display = "none";
            document.getElementById("nuevo-estado").value = "";
        }
    </script>
}
